# å‰ç«¯æƒé™é›†æˆæŠ¥å‘Š

**æ›´æ–°æ—¶é—´**: 2025-11-30
**é—®é¢˜**: ç”¨æˆ·åé¦ˆ"æƒé™åˆ—è¡¨è¿˜æ˜¯æ²¡çœ‹åˆ°AIé…ç½®ç­‰åŠŸèƒ½çš„é€‰é¡¹"
**åŸå› **: å‰ç«¯èœå•æ²¡æœ‰æ ¹æ®æƒé™è¿‡æ»¤ï¼Œæ‰€æœ‰èœå•é¡¹éƒ½æ˜¾ç¤º
**è§£å†³æ–¹æ¡ˆ**: ä¸ºå‰ç«¯èœå•å’Œè·¯ç”±æ·»åŠ å®Œæ•´çš„æƒé™æ§åˆ¶

---

## ğŸ” é—®é¢˜åˆ†æ

### å‘ç°çš„é—®é¢˜

1. **èœå•æ— æƒé™è¿‡æ»¤** - `MainLayout.vue`ä¸­çš„èœå•é¡¹æ²¡æœ‰ä½¿ç”¨`v-if`æŒ‡ä»¤è¿›è¡Œæƒé™æ£€æŸ¥
2. **è·¯ç”±ç¼ºå°‘æƒé™é…ç½®** - AIç›¸å…³è·¯ç”±çš„`meta.permission`å­—æ®µç¼ºå¤±
3. **æƒé™åŠ è½½æ–¹å¼æœ‰é—®é¢˜** - user storeä»`/auth/info`è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä½†è¯¥æ¥å£å¯èƒ½ä¸è¿”å›å®Œæ•´çš„æƒé™åˆ—è¡¨

### å½±å“èŒƒå›´

æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æ‰€æœ‰èœå•é€‰é¡¹ï¼ŒåŒ…æ‹¬ï¼š
- AIå‚å•†ç®¡ç†
- AIæ¨¡å‹ç®¡ç†
- AIé…ç½®ç®¡ç†
- æç¤ºè¯æ¨¡æ¿
- AIæ–‡ç« ç”Ÿæˆ

å³ä½¿ç”¨æˆ·æ²¡æœ‰ç›¸åº”æƒé™ï¼Œèœå•ä¹Ÿä¼šæ˜¾ç¤ºï¼ˆç‚¹å‡»åè¢«è·¯ç”±å®ˆå«æ‹¦æˆªï¼‰ã€‚

---

## âœ¨ ä¿®æ”¹å†…å®¹

### 1. æ–°å¢APIæ–¹æ³• (`frontend/src/api/profile.js`)

```javascript
// è·å–å½“å‰ç”¨æˆ·æƒé™åˆ—è¡¨
export function getPermissions() {
  return request({
    url: '/profile/permissions',
    method: 'get'
  })
}
```

**è¯´æ˜**: è°ƒç”¨åç«¯çš„`/api/profile/permissions`æ¥å£è·å–å½“å‰ç”¨æˆ·çš„å®Œæ•´æƒé™åˆ—è¡¨ã€‚

---

### 2. ä¿®æ”¹æƒé™åŠ è½½é€»è¾‘ (`frontend/src/store/user.js`)

**ä¿®æ”¹å‰**:
```javascript
// ä»ç”¨æˆ·ä¿¡æ¯çš„role.permissionså­—æ®µè·å–æƒé™
if (res.data.role && res.data.role.permissions) {
  let permissions = res.data.role.permissions
  permissionStore.setPermissions(permissions)
}
```

**ä¿®æ”¹å**:
```javascript
// è°ƒç”¨ä¸“é—¨çš„æƒé™APIè·å–æƒé™
const permRes = await getPermissions()
if (permRes.data && permRes.data.permissions) {
  permissionStore.setPermissions(permRes.data.permissions)
} else {
  // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæƒé™APIå¤±è´¥ï¼Œå°è¯•ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
  if (res.data.role && res.data.role.permissions) {
    let permissions = res.data.role.permissions
    permissionStore.setPermissions(permissions)
  }
}
```

**ä¼˜ç‚¹**:
- ä½¿ç”¨ä¸“é—¨çš„æƒé™APIï¼Œæ•°æ®æ›´å‡†ç¡®
- æ”¯æŒç¼“å­˜æœºåˆ¶
- å‘åå…¼å®¹ï¼ˆAPIå¤±è´¥æ—¶å›é€€åˆ°æ—§æ–¹å¼ï¼‰

---

### 3. ä¸ºèœå•æ·»åŠ æƒé™æ§åˆ¶ (`frontend/src/layouts/MainLayout.vue`)

#### 3.1 å¯¼å…¥permission store

```javascript
import { usePermissionStore } from '@/store/permission'

const permissionStore = usePermissionStore()
```

#### 3.2 æ·»åŠ æƒé™æ£€æŸ¥æ–¹æ³•

```javascript
// æƒé™æ£€æŸ¥æ–¹æ³•
const hasPermission = (permission) => {
  return permissionStore.hasPermission(permission)
}

// æ£€æŸ¥æ˜¯å¦æœ‰ä»»æ„AIæƒé™
const hasAnyAiPermission = computed(() => {
  return hasPermission('ai_config.view') ||
         hasPermission('ai_provider.view') ||
         hasPermission('ai_model.view') ||
         hasPermission('ai_prompt.view') ||
         hasPermission('ai_article.view') ||
         hasPermission('ai_image.view')
})
```

#### 3.3 ä¿®æ”¹AIç®¡ç†èœå•

**ä¿®æ”¹å‰**:
```vue
<el-sub-menu index="ai">
  <template #title>
    <el-icon><MagicStick /></el-icon>
    <span>AIç®¡ç†</span>
  </template>
  <el-menu-item index="/ai-providers">AIå‚å•†ç®¡ç†</el-menu-item>
  <el-menu-item index="/ai-models">AIæ¨¡å‹ç®¡ç†</el-menu-item>
  <el-menu-item index="/ai-prompts">æç¤ºè¯æ¨¡æ¿</el-menu-item>
  <el-menu-item index="/ai-configs">AIé…ç½®ç®¡ç†</el-menu-item>
</el-sub-menu>
```

**ä¿®æ”¹å**:
```vue
<el-sub-menu v-if="hasAnyAiPermission" index="ai">
  <template #title>
    <el-icon><MagicStick /></el-icon>
    <span>AIç®¡ç†</span>
  </template>
  <el-menu-item v-if="hasPermission('ai_provider.view')" index="/ai-providers">
    AIå‚å•†ç®¡ç†
  </el-menu-item>
  <el-menu-item v-if="hasPermission('ai_model.view')" index="/ai-models">
    AIæ¨¡å‹ç®¡ç†
  </el-menu-item>
  <el-menu-item v-if="hasPermission('ai_prompt.view')" index="/ai-prompts">
    æç¤ºè¯æ¨¡æ¿
  </el-menu-item>
  <el-menu-item v-if="hasPermission('ai_config.view')" index="/ai-configs">
    AIé…ç½®ç®¡ç†
  </el-menu-item>
</el-sub-menu>
```

**æƒé™æ§åˆ¶é€»è¾‘**:
- æ•´ä¸ª"AIç®¡ç†"å­èœå•åªåœ¨ç”¨æˆ·æœ‰ä»»æ„AIæƒé™æ—¶æ˜¾ç¤ºï¼ˆ`v-if="hasAnyAiPermission"`ï¼‰
- æ¯ä¸ªèœå•é¡¹æ ¹æ®å…·ä½“æƒé™æ˜¾ç¤º/éšè—ï¼ˆ`v-if="hasPermission('...')"`)
- æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚`ai_provider.*`ä¼šåŒ¹é…`ai_provider.view`ï¼‰

---

### 4. ä¸ºè·¯ç”±æ·»åŠ æƒé™å…ƒæ•°æ® (`frontend/src/router/index.js`)

**ä¿®æ”¹å‰**:
```javascript
{
  path: 'ai-providers',
  name: 'AiProviderList',
  component: () => import('@/views/ai/ProviderList.vue'),
  meta: { title: 'AIå‚å•†ç®¡ç†' }  // ç¼ºå°‘permissionå­—æ®µ
}
```

**ä¿®æ”¹å**:
```javascript
{
  path: 'ai-providers',
  name: 'AiProviderList',
  component: () => import('@/views/ai/ProviderList.vue'),
  meta: { title: 'AIå‚å•†ç®¡ç†', permission: 'ai_provider.view' }  // âœ… æ·»åŠ æƒé™
}
```

**å®Œæ•´çš„AIè·¯ç”±æƒé™é…ç½®**:
```javascript
// AIå‚å•†ç®¡ç†
{ path: 'ai-providers', meta: { permission: 'ai_provider.view' } }

// AIæ¨¡å‹ç®¡ç†
{ path: 'ai-models', meta: { permission: 'ai_model.view' } }

// æç¤ºè¯æ¨¡æ¿
{ path: 'ai-prompts', meta: { permission: 'ai_prompt.view' } }

// AIé…ç½®ç®¡ç†
{ path: 'ai-configs', meta: { permission: 'ai_config.view' } }

// AIæ–‡ç« ç”Ÿæˆ
{ path: 'ai-tasks', meta: { permission: 'ai_article.view' } }
```

**è·¯ç”±å®ˆå«æ£€æŸ¥**:
è·¯ç”±å®ˆå«ï¼ˆ`router/index.js` line 434-444ï¼‰ä¼šè‡ªåŠ¨æ£€æŸ¥æƒé™ï¼š
```javascript
if (to.meta.permission) {
  const permissionStore = usePermissionStore()
  const hasPermission = permissionStore.hasPermission(to.meta.permission)

  if (!hasPermission) {
    ElMessage.error('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢')
    next('/dashboard')
    return
  }
}
```

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `frontend/src/api/profile.js` | æ–°å¢ | æ·»åŠ `getPermissions()`æ–¹æ³• |
| `frontend/src/store/user.js` | ä¿®æ”¹ | è°ƒç”¨æƒé™APIåŠ è½½æƒé™ |
| `frontend/src/layouts/MainLayout.vue` | ä¿®æ”¹ | æ·»åŠ èœå•æƒé™æ§åˆ¶ |
| `frontend/src/router/index.js` | ä¿®æ”¹ | æ·»åŠ AIè·¯ç”±æƒé™å…ƒæ•°æ® |

---

## ğŸ¯ æƒé™è¿‡æ»¤æ•ˆæœ

### è¶…çº§ç®¡ç†å‘˜ï¼ˆæ‹¥æœ‰`*`æƒé™ï¼‰
âœ… çœ‹åˆ°æ‰€æœ‰èœå•é¡¹
- AIå‚å•†ç®¡ç†
- AIæ¨¡å‹ç®¡ç†
- AIé…ç½®ç®¡ç†
- æç¤ºè¯æ¨¡æ¿
- AIæ–‡ç« ç”Ÿæˆ

### ç®¡ç†å‘˜ï¼ˆæ‹¥æœ‰`ai_config.*`ç­‰æƒé™ï¼‰
âœ… çœ‹åˆ°æ‰€æœ‰AIç›¸å…³èœå•é¡¹
- AIå‚å•†ç®¡ç†ï¼ˆ`ai_provider.*`åŒ…å«`ai_provider.view`ï¼‰
- AIæ¨¡å‹ç®¡ç†ï¼ˆ`ai_model.*`åŒ…å«`ai_model.view`ï¼‰
- AIé…ç½®ç®¡ç†ï¼ˆ`ai_config.*`åŒ…å«`ai_config.view`ï¼‰
- æç¤ºè¯æ¨¡æ¿ï¼ˆ`ai_prompt.*`åŒ…å«`ai_prompt.view`ï¼‰
- AIæ–‡ç« ç”Ÿæˆï¼ˆ`ai_article.*`åŒ…å«`ai_article.view`ï¼‰

### ç¼–è¾‘ï¼ˆåªæœ‰`ai_prompt.view`, `ai_article.view`ç­‰æƒé™ï¼‰
âœ… çœ‹åˆ°éƒ¨åˆ†AIèœå•é¡¹
- AIæ–‡ç« ç”Ÿæˆ âœ…
- æç¤ºè¯æ¨¡æ¿ âœ…ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰
- AIå‚å•†ç®¡ç† âŒï¼ˆæ²¡æœ‰`ai_provider.view`æƒé™ï¼‰
- AIæ¨¡å‹ç®¡ç† âŒï¼ˆæ²¡æœ‰`ai_model.view`æƒé™ï¼‰
- AIé…ç½®ç®¡ç† âŒï¼ˆæ²¡æœ‰`ai_config.view`æƒé™ï¼‰

### ä½œè€…ï¼ˆåªæœ‰`ai_article.view`, `ai_image.view`æƒé™ï¼‰
âœ… çœ‹åˆ°éƒ¨åˆ†AIåŠŸèƒ½
- AIæ–‡ç« ç”Ÿæˆ âœ…ï¼ˆæœ‰`ai_article.view`æƒé™ï¼‰
- å…¶ä»–AIèœå•é¡¹ âŒï¼ˆæ²¡æœ‰æƒé™ï¼‰

### æ— AIæƒé™çš„ç”¨æˆ·
âŒ æ•´ä¸ª"AIç®¡ç†"èœå•éšè—

---

## ğŸ” æƒé™æ£€æŸ¥æµç¨‹

```
1. ç”¨æˆ·ç™»å½•
   â†“
2. è°ƒç”¨ /auth/info è·å–ç”¨æˆ·ä¿¡æ¯
   â†“
3. è°ƒç”¨ /profile/permissions è·å–æƒé™åˆ—è¡¨
   â†“
4. å­˜å‚¨åˆ° permissionStore
   â†“
5. æ¸²æŸ“èœå•æ—¶æ£€æŸ¥æƒé™
   â”œâ”€ hasPermission('ai_config.view') â†’ æ˜¾ç¤º/éšè— AIé…ç½®ç®¡ç†
   â”œâ”€ hasPermission('ai_provider.view') â†’ æ˜¾ç¤º/éšè— AIå‚å•†ç®¡ç†
   â”œâ”€ hasPermission('ai_model.view') â†’ æ˜¾ç¤º/éšè— AIæ¨¡å‹ç®¡ç†
   â””â”€ ...
   â†“
6. ç”¨æˆ·ç‚¹å‡»èœå•
   â†“
7. è·¯ç”±å®ˆå«æ£€æŸ¥ meta.permission
   â”œâ”€ æœ‰æƒé™ â†’ å…è®¸è®¿é—®
   â””â”€ æ— æƒé™ â†’ è·³è½¬åˆ°é¦–é¡µ + æç¤ºé”™è¯¯
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜** - ç¡®ä¿åŠ è½½æœ€æ–°ä»£ç 
   ```bash
   Ctrl+Shift+Delete (æ¸…ç©ºç¼“å­˜)
   æˆ– Ctrl+F5 (å¼ºåˆ¶åˆ·æ–°)
   ```

2. **ä½¿ç”¨managerè´¦å·ç™»å½•**
   - ç”¨æˆ·å: `manager`
   - å¯†ç : `admin123`
   - è§’è‰²: ç®¡ç†å‘˜ï¼ˆrole_id=2ï¼‰

3. **æ£€æŸ¥èœå•æ˜¾ç¤º**
   - âœ… åº”è¯¥çœ‹åˆ°"AIç®¡ç†"èœå•
   - âœ… ä¸‹é¢æœ‰4ä¸ªå­èœå•é¡¹ï¼š
     - AIå‚å•†ç®¡ç†
     - AIæ¨¡å‹ç®¡ç†
     - AIé…ç½®ç®¡ç†
     - æç¤ºè¯æ¨¡æ¿

4. **æ£€æŸ¥æƒé™æ•°æ®**ï¼ˆæµè§ˆå™¨Consoleï¼‰
   ```javascript
   // æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· Console
   // è¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æƒé™
   JSON.parse(localStorage.getItem('permissions'))
   ```
   åº”è¯¥åŒ…å«ï¼š
   ```json
   [
     "ai_config.*",
     "ai_provider.*",
     "ai_model.*",
     "ai_prompt.*",
     // ... å…¶ä»–æƒé™
   ]
   ```

5. **æµ‹è¯•è®¿é—®æ§åˆ¶**
   - ç‚¹å‡»"AIé…ç½®ç®¡ç†"èœå• â†’ åº”è¯¥èƒ½æ­£å¸¸è®¿é—®
   - ç›´æ¥è®¿é—®URL `/ai-configs` â†’ åº”è¯¥èƒ½æ­£å¸¸è®¿é—®
   - é€€å‡ºç™»å½•ï¼Œç”¨authorè´¦å·ç™»å½• â†’ "AIç®¡ç†"èœå•åº”è¯¥éšè—æˆ–åªæ˜¾ç¤ºéƒ¨åˆ†é¡¹

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç™»å½•åè¿˜æ˜¯çœ‹ä¸åˆ°AIèœå•ï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+F5å¼ºåˆ¶åˆ·æ–°ï¼‰
2. æ£€æŸ¥localStorageä¸­çš„æƒé™æ•°æ®ï¼š
   ```javascript
   console.log(JSON.parse(localStorage.getItem('permissions')))
   ```
3. é‡æ–°ç™»å½•ï¼ˆé€€å‡ºåé‡æ–°ç™»å½•ï¼‰
4. æ£€æŸ¥åç«¯æƒé™APIæ˜¯å¦æ­£å¸¸ï¼š
   ```bash
   curl -X GET http://localhost:8000/api/profile/permissions \
     -H "Authorization: Bearer {ä½ çš„token}"
   ```

### Q2: ConsoleæŠ¥é”™"Cannot read property 'hasPermission' of undefined"ï¼Ÿ

**A**: permissionStoreæœªåˆå§‹åŒ–ï¼Œå¯èƒ½æ˜¯ï¼š
1. ç”¨æˆ·æœªç™»å½•
2. getUserInfo()æ–¹æ³•æ‰§è¡Œå¤±è´¥
3. æ£€æŸ¥networkè¯·æ±‚ï¼Œçœ‹`/profile/permissions`æ˜¯å¦è¿”å›æ­£ç¡®æ•°æ®

### Q3: æ‰€æœ‰èœå•éƒ½æ¶ˆå¤±äº†ï¼Ÿ

**A**: å¯èƒ½æƒé™æ•°æ®åŠ è½½å¤±è´¥ï¼ŒpermissionStoreä¸ºç©ºï¼š
1. æ£€æŸ¥Consoleé”™è¯¯æ—¥å¿—
2. æ£€æŸ¥`/profile/permissions` APIå“åº”
3. ä¸´æ—¶è§£å†³ï¼šæ¸…ç©ºlocalStorageé‡æ–°ç™»å½•

### Q4: èœå•æ˜¾ç¤ºäº†ä½†ç‚¹å‡»æç¤º"æ²¡æœ‰æƒé™"ï¼Ÿ

**A**: è¯´æ˜èœå•æƒé™æ£€æŸ¥å’Œè·¯ç”±æƒé™æ£€æŸ¥ä¸ä¸€è‡´ï¼š
1. æ£€æŸ¥`MainLayout.vue`ä¸­çš„`hasPermission()`è°ƒç”¨
2. æ£€æŸ¥`router/index.js`ä¸­çš„`meta.permission`é…ç½®
3. ç¡®ä¿ä¸¤è€…ä½¿ç”¨åŒæ ·çš„æƒé™å­—ç¬¦ä¸²

---

## ğŸ“ åç»­å»ºè®®

### 1. ä¸ºå…¶ä»–èœå•æ·»åŠ æƒé™æ§åˆ¶

å»ºè®®ä¸ºä»¥ä¸‹èœå•ä¹Ÿæ·»åŠ æƒé™æ§åˆ¶ï¼š

```vue
<!-- å†…å®¹ç®¡ç† -->
<el-sub-menu v-if="hasAnyContentPermission" index="content">
  <el-menu-item v-if="hasPermission('article.view')" index="/articles">
    æ–‡ç« åˆ—è¡¨
  </el-menu-item>
  <!-- ... -->
</el-sub-menu>

<!-- ç³»ç»Ÿç®¡ç† -->
<el-sub-menu v-if="hasAnySystemPermission" index="system">
  <el-menu-item v-if="hasPermission('site.view')" index="/sites">
    å¤šç«™ç‚¹ç®¡ç†
  </el-menu-item>
  <!-- ... -->
</el-sub-menu>
```

### 2. åˆ›å»ºèœå•é…ç½®æ–‡ä»¶

å°†èœå•é…ç½®ä»`MainLayout.vue`ä¸­æå–åˆ°å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼š

```javascript
// frontend/src/config/menu.js
export const menuConfig = [
  {
    key: 'ai',
    title: 'AIç®¡ç†',
    icon: 'MagicStick',
    permission: ['ai_config.view', 'ai_provider.view', '...'],
    permissionMode: 'any',
    children: [
      {
        key: '/ai-configs',
        title: 'AIé…ç½®ç®¡ç†',
        permission: 'ai_config.view'
      },
      // ...
    ]
  },
  // ...
]
```

### 3. ä½¿ç”¨Permissionç»„ä»¶

å¯ä»¥ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„`<Permission>`ç»„ä»¶ï¼š

```vue
<Permission :permission="['ai_config.view']">
  <el-menu-item index="/ai-configs">AIé…ç½®ç®¡ç†</el-menu-item>
</Permission>
```

---

## æ€»ç»“

âœ… **å·²è§£å†³é—®é¢˜**: å‰ç«¯èœå•ç°åœ¨ä¼šæ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€æ˜¾ç¤º/éšè—
âœ… **æƒé™æ£€æŸ¥**: èœå•çº§åˆ« + è·¯ç”±çº§åˆ«åŒé‡æ£€æŸ¥
âœ… **æ•°æ®æ¥æº**: ä½¿ç”¨ä¸“é—¨çš„`/api/profile/permissions`æ¥å£è·å–æƒé™
âœ… **å‘åå…¼å®¹**: APIå¤±è´¥æ—¶å›é€€åˆ°ä»ç”¨æˆ·ä¿¡æ¯è·å–æƒé™
âœ… **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·åªèƒ½çœ‹åˆ°æœ‰æƒé™çš„èœå•é¡¹

**ç°åœ¨ç”¨æˆ·ç™»å½•ååº”è¯¥èƒ½æ­£ç¡®çœ‹åˆ°AIé…ç½®ç­‰åŠŸèƒ½é€‰é¡¹äº†ï¼** ğŸ‰

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-30
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯
