# 模板套装功能 - 升级部署说明

## 📋 升级概述

本次升级实现了**模板套装**功能，允许管理员整套管理和切换网站模板。

## 🎯 新功能

1. ✅ 支持多套模板并存
2. ✅ 一键切换整套模板
3. ✅ 自动应用到所有页面
4. ✅ 独立的主题配置文件

## 📦 需要上传的文件

### 后端文件 (backend/)
```
backend/app/controller/backend/Template.php          # 模板管理控制器
backend/app/controller/backend/Build.php             # 静态生成控制器（已更新）
backend/route/api.php                            # 路由配置（已更新）
backend/templates/default/                       # 默认模板套装（新目录）
├── theme.json
├── layout.html
├── index.html
├── category.html
├── page.html
├── article.html
├── articles.html
└── tag.html
backend/templates/green/                         # 示例：绿色主题（可选）
└── ...
```

### 前端文件 (frontend/)
```
frontend/src/backend/template.js                  # API调用（已更新）
frontend/src/views/config/Index.vue           # 系统配置界面（已更新）
```

### 数据库脚本
```
database_template_theme.sql                  # 数据库更新脚本
```

### 迁移脚本
```
migrate_templates.php                        # 模板迁移脚本
```

## 🔧 部署步骤

### 步骤 1: 备份
```bash
# 备份数据库
mysqldump -u用户名 -p cms_database > backup_$(date +%Y%m%d).sql

# 备份现有模板文件
cp -r backend/templates backend/templates_backup_$(date +%Y%m%d)
```

### 步骤 2: 上传文件到服务器

#### 上传后端文件
```bash
# 上传控制器
scp backend/app/controller/backend/Template.php root@服务器:/www/wwwroot/cms/backend/app/controller/backend/
scp backend/app/controller/backend/Build.php root@服务器:/www/wwwroot/cms/backend/app/controller/backend/

# 上传路由配置
scp backend/route/api.php root@服务器:/www/wwwroot/cms/backend/route/

# 上传模板目录（注意：会创建default和green目录）
scp -r backend/templates/default root@服务器:/www/wwwroot/cms/backend/templates/
scp -r backend/templates/green root@服务器:/www/wwwroot/cms/backend/templates/

# 上传数据库脚本
scp database_template_theme.sql root@服务器:/www/wwwroot/cms/

# 上传迁移脚本
scp migrate_templates.php root@服务器:/www/wwwroot/cms/
```

#### 上传前端文件
```bash
# 先在本地构建
cd frontend
npm run build

# 上传构建后的文件
scp -r dist/* root@服务器:/www/wwwroot/cms-admin/
```

### 步骤 3: 执行数据库更新
```bash
# SSH 登录到服务器
ssh root@服务器

# 进入项目目录
cd /www/wwwroot/cms

# 执行数据库更新
mysql -uroot -p密码 < database_template_theme.sql
```

### 步骤 4: 运行模板迁移脚本
```bash
# 在服务器上执行
cd /www/wwwroot/cms
php migrate_templates.php
```

**预期输出：**
```
✓ 已迁移 layout.html
✓ 已迁移 index.html
✓ 已迁移 category.html
✓ 已迁移 page.html
✓ 已迁移 article.html
✓ 已迁移 articles.html
✓ 已迁移 tag.html
✓ 已创建 theme.json 配置文件

============================================
迁移完成！
已迁移文件数: 7
跳过文件数: 0
============================================
```

### 步骤 5: 验证部署

1. **检查目录结构**
   ```bash
   ls -la backend/templates/
   ```
   应该看到：
   ```
   default/
   green/
   ```

2. **检查default目录**
   ```bash
   ls -la backend/templates/default/
   ```
   应该看到所有模板文件和 `theme.json`

3. **检查数据库**
   ```bash
   mysql -uroot -p -e "SELECT config_key, config_value FROM cms_database.site_config WHERE config_key='current_template_theme';"
   ```
   应该看到：
   ```
   +------------------------+--------------+
   | config_key             | config_value |
   +------------------------+--------------+
   | current_template_theme | default      |
   +------------------------+--------------+
   ```

### 步骤 6: 前端测试

1. 访问管理后台
2. 进入 **系统配置** 页面
3. 找到"模板设置"部分
4. 应该能看到"当前模板套装"下拉框
5. 下拉框中应该有 `default` 和 `green` 两个选项

### 步骤 7: 功能测试

#### 测试 1: 查看当前模板
- 当前应该显示为 "Default (default)"

#### 测试 2: 切换模板
1. 选择 "绿色清新模板 (green)"
2. 确认切换
3. 应该提示"模板套装切换成功"

#### 测试 3: 重新生成静态页面
1. 进入 **静态生成** 页面
2. 点击 "生成所有静态页面"
3. 等待生成完成

#### 测试 4: 验证前端显示
访问静态网站，检查页面是否正常显示

## ⚠️ 注意事项

### 1. 迁移脚本只运行一次
`migrate_templates.php` 只需要运行一次，它会将现有的模板文件移动到 `default` 目录。

### 2. 如果迁移失败
如果迁移脚本执行失败或中断：

```bash
# 1. 删除 default 目录
rm -rf backend/templates/default

# 2. 从备份恢复原始模板
cp -r backend/templates_backup/* backend/templates/

# 3. 重新运行迁移脚本
php migrate_templates.php
```

### 3. 保留旧模板文件
迁移后，如果 `backend/templates/` 根目录下还有 `.html` 文件（旧文件），可以删除：

```bash
cd frontend/templates/
ls *.html    # 查看是否还有旧文件
rm *.html    # 删除旧文件（如果有）
```

但**不要删除**目录，只删除根目录下的 `.html` 文件。

### 4. 权限问题
确保 Web 服务器对模板目录有读取权限：

```bash
chown -R www:www backend/templates/
chmod -R 755 backend/templates/
```

### 5. 缓存清理
部署完成后，清除缓存：

```bash
# 清除 ThinkPHP 缓存
rm -rf backend/runtime/*

# 清除 OPcache（如果有）
service php-fpm reload
```

## 🔄 回滚方案

如果升级后出现问题，可以回滚：

### 1. 回滚数据库
```bash
# 删除新增的配置项
mysql -uroot -p -e "DELETE FROM cms_database.site_config WHERE config_key='current_template_theme';"
```

### 2. 恢复模板文件
```bash
# 删除新目录
rm -rf backend/templates/default
rm -rf backend/templates/green

# 恢复备份
cp -r backend/templates_backup/* backend/templates/
```

### 3. 恢复旧版本文件
```bash
# 恢复旧的控制器和路由
# （从备份中恢复）
```

## 📊 升级检查清单

升级前检查：
- [ ] 已备份数据库
- [ ] 已备份现有模板文件
- [ ] 已确认服务器 PHP 版本 >= 8.0
- [ ] 已确认 MySQL 版本 >= 8.0

升级中检查：
- [ ] 数据库更新脚本执行成功
- [ ] 模板迁移脚本执行成功
- [ ] 文件上传完整

升级后检查：
- [ ] 前端配置页面显示正常
- [ ] 可以看到模板套装列表
- [ ] 可以切换模板套装
- [ ] 静态页面生成正常
- [ ] 前端网站显示正常

## 🆘 故障排查

### 问题 1: 看不到模板套装选择器
**原因**: 前端文件未更新或浏览器缓存

**解决**:
```bash
# 1. 确认前端文件已上传
ls -la /www/wwwroot/cms-admin/

# 2. 清除浏览器缓存
按 Ctrl+F5 强制刷新
```

### 问题 2: 切换主题失败
**原因**: 数据库未更新或权限问题

**解决**:
```bash
# 1. 检查数据库
mysql -uroot -p -e "SELECT * FROM cms_database.site_config WHERE config_key='current_template_theme';"

# 2. 检查文件权限
ls -la backend/templates/

# 3. 检查日志
tail -f backend/runtime/log/error.log
```

### 问题 3: 静态页面生成失败
**原因**: 模板文件路径错误

**解决**:
```bash
# 检查 default 目录是否存在所有模板
ls -la backend/templates/default/

# 应该有这些文件:
# - layout.html
# - index.html
# - category.html
# - page.html
# - article.html
# - articles.html
# - tag.html
# - theme.json
```

### 问题 4: 前端报 API 错误
**原因**: 路由未更新

**解决**:
```bash
# 重新上传路由文件
scp backend/route/api.php root@服务器:/www/wwwroot/cms/backend/route/

# 清除缓存
rm -rf backend/runtime/*
```

## 📞 技术支持

如遇到问题，请提供：
1. 错误信息截图
2. 浏览器控制台错误
3. 服务器日志 `backend/runtime/log/error.log`
4. 执行的具体步骤

---

**升级时间**: 2025-10-16
**升级版本**: v2.0
**预计耗时**: 15-30分钟
