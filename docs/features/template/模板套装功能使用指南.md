# 模板套装功能使用指南

## 🎨 功能概述

模板套装功能允许您管理多套完整的网站模板，并一键切换整站风格。每个模板套装是一个独立的目录，包含所有页面的模板文件。

## ✨ 主要特性

1. **整套管理** - 所有模板文件放在一个目录下，便于管理
2. **一键切换** - 切换模板套装时自动应用到所有页面
3. **灵活扩展** - 可以轻松添加新的模板套装
4. **独立配置** - 每个模板套装有独立的配置文件

## 📁 目录结构

```
backend/templates/
├── default/              # 默认模板套装
│   ├── theme.json       # 主题配置文件
│   ├── layout.html      # 公共布局
│   ├── index.html       # 首页模板
│   ├── category.html    # 分类页模板
│   ├── page.html        # 单页模板
│   ├── article.html     # 文章详情模板
│   ├── articles.html    # 文章列表模板
│   └── tag.html         # 标签页模板
│
├── green/               # 绿色主题套装
│   ├── theme.json
│   ├── layout.html
│   ├── index.html
│   └── ...
│
└── blue/                # 蓝色主题套装（示例）
    ├── theme.json
    └── ...
```

## 🔧 已完成的功能

### 1. 数据库更新 ✅
- 添加了 `current_template_theme` 配置项存储当前使用的模板套装

### 2. 后端 API ✅

#### Template 控制器新增方法
- `scanThemes()` - 扫描所有模板套装
- `getCurrentTheme()` - 获取当前模板套装信息
- `switchTheme()` - 切换模板套装
- `scanTemplates($themeKey)` - 扫描指定套装下的模板文件

#### Build 控制器更新
- 支持从模板套装目录读取模板
- 自动识别当前模板套装
- 使用 `getTemplatePath()` 方法构建正确的模板路径

### 3. 前端管理界面 ✅

#### 系统配置页面
- 添加"当前模板套装"选择器
- 显示所有可用的模板套装
- 支持一键切换并自动应用

### 4. API 路由 ✅
```
GET  /backend/templates/themes          # 扫描所有模板套装
GET  /backend/templates/current-theme   # 获取当前模板套装
POST /backend/templates/switch-theme    # 切换模板套装
GET  /backend/templates/scan            # 扫描模板文件
```

## 📖 使用方法

### 查看可用的模板套装

1. 登录后台管理系统
2. 进入 **系统配置** 页面
3. 找到"模板设置"部分
4. 在"当前模板套装"下拉框中可以看到所有可用的模板套装

### 切换模板套装

1. 在"当前模板套装"下拉框中选择要使用的套装
2. 系统会弹出确认对话框（因为会影响所有页面）
3. 点击"确定"后，系统会自动：
   - 更新当前模板套装配置
   - 将首页模板设置为 `index`
   - 将所有分类的模板设置为 `category`
   - 将所有单页的模板设置为 `page`
4. 切换完成后，重新生成静态页面即可

### 创建新的模板套装

#### 方法一：手动创建

1. **创建目录**
   ```bash
   mkdir backend/templates/mytheme
   ```

2. **创建配置文件** `theme.json`
   ```json
   {
       "key": "mytheme",
       "name": "我的主题",
       "description": "这是我的自定义主题",
       "author": "Your Name",
       "version": "1.0.0",
       "preview": "/path/to/preview.jpg"
   }
   ```

3. **创建模板文件**
   至少需要以下文件：
   - `layout.html` - 公共布局
   - `index.html` - 首页
   - `category.html` - 分类页
   - `page.html` - 单页
   - `article.html` - 文章详情
   - `articles.html` - 文章列表
   - `tag.html` - 标签页

4. **刷新管理界面**
   重新进入系统配置页面，新主题会自动出现在列表中

#### 方法二：复制现有主题

```bash
# 复制 default 主题为基础
cp -r backend/templates/default backend/templates/mytheme

# 修改配置文件
nano backend/templates/mytheme/theme.json

# 根据需要修改模板文件
```

## 🎯 theme.json 配置说明

```json
{
    "key": "mytheme",              // 主题标识（必需，英文）
    "name": "我的主题",             // 主题名称（必需）
    "description": "主题描述",      // 主题描述（可选）
    "author": "作者名",             // 作者（可选）
    "version": "1.0.0",            // 版本号（可选）
    "preview": "/preview.jpg"      // 预览图路径（可选）
}
```

## 💡 模板文件说明

### layout.html - 公共布局
所有页面的基础布局，包含：
- HTML 头部
- 导航菜单
- 页脚
- 公共CSS/JS

其他模板继承此布局：
```html
{extend name="layout" /}

{block name="content"}
<!-- 页面内容 -->
{/block}
```

### index.html - 首页模板
可用变量：
```php
{$articles}      // 最新文章列表
{$config}        // 网站配置
{$is_home}       // 是否为首页
```

### category.html - 分类页模板
可用变量：
```php
{$category}      // 分类信息
{$articles}      // 该分类下的文章
{$config}        // 网站配置
{$title}         // 页面标题
{$keywords}      // SEO关键词
{$description}   // SEO描述
```

### page.html - 单页模板
可用变量：
```php
{$page}          // 单页信息
{$config}        // 网站配置
{$title}         // 页面标题
{$keywords}      // SEO关键词
{$description}   // SEO描述
```

### article.html - 文章详情模板
可用变量：
```php
{$article}       // 文章详细信息
{$prev}          // 上一篇文章
{$next}          // 下一篇文章
{$config}        // 网站配置
```

### articles.html - 文章列表模板
可用变量：
```php
{$articles}      // 文章列表
{$pagination}    // 分页信息
{$config}        // 网站配置
```

### tag.html - 标签页模板
可用变量：
```php
{$tag}           // 标签信息
{$articles}      // 该标签下的文章
{$config}        // 网站配置
```

## ⚙️ 技术实现

### 模板路径构建
```php
// Build.php 控制器
protected function getTemplatePath($template)
{
    // 返回格式：/套装名/模板名
    return '/' . $this->currentTheme . '/' . $template;
}

// 使用示例
$content = View::fetch($this->getTemplatePath('index'), $data);
// 实际渲染：/default/index 或 /green/index
```

### 切换流程
```php
public function switchTheme()
{
    // 1. 验证模板套装存在
    // 2. 开启数据库事务
    // 3. 更新 current_template_theme 配置
    // 4. 更新首页模板为 index
    // 5. 更新所有分类模板为 category
    // 6. 更新所有单页模板为 page
    // 7. 提交事务
}
```

## 🔄 迁移步骤

如果您是从旧版本升级：

1. **备份现有模板**
   ```bash
   cp -r backend/templates backend/templates_backup
   ```

2. **执行数据库更新**
   ```bash
   mysql -u用户名 -p < database_template_theme.sql
   ```

3. **运行迁移脚本**
   ```bash
   php migrate_templates.php
   ```

4. **上传新文件到服务器**
   - 后端文件（backend/）
   - 前端文件（frontend/dist/）

5. **重新生成静态页面**
   在后台 "静态生成" → "生成所有静态页面"

## 📝 注意事项

1. **模板套装命名**
   - 只使用小写字母、数字和连字符
   - 不要使用中文或特殊字符
   - 例如：`default`, `green`, `blue-theme`

2. **必需文件**
   每个模板套装必须包含：
   - `theme.json` 配置文件
   - `layout.html` 公共布局
   - 至少一个页面模板

3. **切换影响**
   切换模板套装会影响：
   - 首页模板
   - 所有分类的模板
   - 所有单页的模板
   - **需要重新生成静态页面才能生效**

4. **模板语法**
   使用 ThinkPHP 模板引擎语法
   - 变量输出：`{$var}`
   - 循环：`{volist name="list" id="item"}...{/volist}`
   - 判断：`{if condition}...{/if}`

## 🎨 最佳实践

### 1. 保持一致性
同一套装内的所有模板应该保持风格一致：
- 统一的配色方案
- 一致的布局结构
- 相同的字体和间距

### 2. 合理使用 layout.html
将公共部分放在 layout.html 中：
```html
<!DOCTYPE html>
<html>
<head>
    <title>{$title|default=$config.site_name}</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <!-- 公共头部 -->
    </header>

    {block name="content"}
    <!-- 各个页面的内容区域 -->
    {/block}

    <footer>
        <!-- 公共页脚 -->
    </footer>
</body>
</html>
```

### 3. 测试完整性
创建新模板套装后，测试所有页面类型：
- ✓ 首页显示正常
- ✓ 分类页显示正常
- ✓ 文章详情显示正常
- ✓ 单页显示正常
- ✓ 标签页显示正常

### 4. 版本控制
为模板套装做好版本管理：
```json
{
    "version": "1.0.0",
    "changelog": {
        "1.0.0": "初始版本",
        "1.1.0": "优化布局，增加响应式支持"
    }
}
```

## 🐛 常见问题

### Q: 切换主题后页面没有变化？
A: 需要重新生成静态页面。进入"静态生成" → "生成所有静态页面"

### Q: 新创建的主题没有出现在列表中？
A: 检查：
1. 目录是否在 `backend/templates/` 下
2. 是否有 `theme.json` 文件
3. `theme.json` 格式是否正确

### Q: 切换主题失败？
A: 检查：
1. 目标主题目录是否存在
2. 是否有必需的模板文件
3. 检查错误日志

### Q: 某些页面使用了旧主题？
A: 可能是：
1. 没有重新生成静态页面
2. 浏览器缓存，按 Ctrl+F5 强制刷新

## 🔗 相关文件

- `database_template_theme.sql` - 数据库更新脚本
- `migrate_templates.php` - 模板迁移脚本
- `backend/app/controller/backend/Template.php` - 模板管理控制器
- `backend/app/controller/backend/Build.php` - 静态生成控制器
- `frontend/src/backend/template.js` - 前端API调用
- `frontend/src/views/config/Index.vue` - 系统配置界面

---

**开发时间**: 2025-10-16
**版本**: v2.0
**技术栈**: ThinkPHP 8 + Vue 3 + Element Plus
