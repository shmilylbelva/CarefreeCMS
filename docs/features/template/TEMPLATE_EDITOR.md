# 在线模板编辑器使用指南

## 功能概述

在线模板编辑器允许您直接在浏览器中编辑网站模板文件，无需通过FTP或SSH连接服务器。支持实时预览、自动备份、版本恢复等功能。

## 访问路径

后台管理 → 系统管理 → 模板编辑器

路由地址：`/template-editor`

## 主要功能

### 1. 模板套装切换

- 顶部下拉菜单可以选择不同的模板套装（default、green、official等）
- 切换套装后会自动加载该套装下的所有文件

### 2. 文件浏览

**左侧文件树显示：**
- 📁 文件夹图标 - 目录
- 📄 文件图标 - 文件

**支持的文件类型：**
- `.html` - HTML模板文件
- `.css` - 样式文件
- `.js` - JavaScript文件
- `.json` - 配置文件

### 3. 在线编辑

**编辑器功能：**
- ✅ 语法高亮显示
- ✅ 自动检测未保存修改
- ✅ 实时文件大小显示
- ✅ 最后修改时间显示

**操作按钮：**
- **保存** - 保存当前编辑的内容（会自动创建备份）
- **重新加载** - 放弃修改并重新加载文件
- **删除** - 删除当前文件（会先创建备份到回收站）

### 4. 文件管理

#### 创建新文件

1. 点击左上角"新建"按钮
2. 输入文件名（例如：`custom.html`）
3. 选择文件类型：
   - HTML模板
   - CSS样式
   - JavaScript
4. 点击"创建"

**系统会自动生成模板内容：**

```html
<!-- HTML模板 -->
{extend name="layout" /}

{block name="content"}
<div class="content-box">
    <h2>新页面</h2>
    <p>在这里添加内容...</p>
</div>
{/block}
```

```css
/* CSS样式 */
body {
    font-family: Arial, sans-serif;
}
```

```javascript
// JavaScript 文件
console.log("Hello World");
```

#### 删除文件

1. 打开要删除的文件
2. 点击右上角"删除"按钮
3. 确认删除操作

**注意：** 删除前会自动创建备份到 `templates/.trash/` 目录

### 5. 自动备份机制

**每次保存文件时：**
- 自动创建备份文件（文件名格式：`原文件名.backup.20251021123456`）
- 自动保留最近5个备份版本
- 超过5个时自动删除最旧的备份

**查看备份：**
1. 打开需要查看备份的文件
2. 点击文件信息栏中的"查看备份"链接
3. 在弹出的对话框中查看备份列表

### 6. 修改检测

编辑器会实时检测文件是否有未保存的修改：

- ✅ **有修改** - "保存"按钮高亮可用
- ⚠️ **切换文件前** - 提示是否放弃未保存的修改
- ⚠️ **重新加载前** - 提示是否放弃未保存的修改

## 常见模板文件说明

### 核心模板文件

| 文件名 | 说明 | 用途 |
|--------|------|------|
| `layout.html` | 布局模板 | 网站的整体框架，包含头部、底部 |
| `index.html` | 首页模板 | 网站首页 |
| `article.html` | 文章详情模板 | 单篇文章展示 |
| `articles.html` | 文章列表模板 | 文章列表页 |
| `category.html` | 分类模板 | 分类列表页 |
| `tag.html` | 标签模板 | 标签文章列表 |
| `page.html` | 单页模板 | 关于我们、联系我们等单页 |

### 配置文件

| 文件名 | 说明 |
|--------|------|
| `theme.json` | 模板套装配置文件 |

**theme.json 示例：**

```json
{
  "key": "default",
  "name": "默认模板",
  "description": "简洁的默认模板",
  "author": "CarefreeCMS Team",
  "version": "1.0.0",
  "preview": "/preview.jpg"
}
```

## 模板语法

### ThinkPHP 模板语法

#### 1. 变量输出

```html
{$article.title}                    <!-- 输出文章标题 -->
{$article.category.name}            <!-- 输出分类名称 -->
{$article.publish_time|date='Y-m-d'} <!-- 格式化日期 -->
```

#### 2. 条件判断

```html
{if $article.cover_image}
    <img src="{$article.cover_image}" alt="{$article.title}">
{else /}
    <img src="/default.jpg" alt="默认图片">
{/if}
```

#### 3. 循环

```html
{volist name="articles" id="article"}
    <article>
        <h3><a href="/article/{$article.id}.html">{$article.title}</a></h3>
        <p>{$article.summary}</p>
    </article>
{/volist}
```

#### 4. 模板继承

```html
<!-- 子模板 -->
{extend name="layout" /}

{block name="content"}
    <!-- 这里的内容会替换layout.html中的content块 -->
{/block}
```

```html
<!-- layout.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{$site_name}</title>
</head>
<body>
    {block name="content"}
        默认内容
    {/block}
</body>
</html>
```

#### 5. 包含文件

```html
{include file="header" /}
{include file="footer" /}
```

## 最佳实践

### 1. 编辑前备份

虽然系统会自动备份，但重要修改前建议：
- 先手动保存当前版本
- 记录修改内容
- 测试后再正式使用

### 2. 渐进式修改

- 不要一次修改太多内容
- 每修改一个功能就保存一次
- 便于出错时回滚

### 3. 测试环境

- 建议先在测试套装中修改
- 确认无误后再修改生产套装
- 使用不同的模板套装进行AB测试

### 4. 版本管理

- 定期下载重要模板文件到本地
- 保持备份文件清单
- 记录每次重大修改

### 5. 性能优化

- 压缩CSS和JavaScript
- 优化图片引用
- 减少不必要的HTTP请求

## 安全建议

### 1. 权限控制

- 仅授权信任的管理员访问模板编辑器
- 定期审查操作日志
- 重要操作后检查文件完整性

### 2. 代码审查

- 避免在模板中直接写PHP代码
- 不要在模板中处理敏感数据
- 使用模板语法而不是原生代码

### 3. 备份策略

- 自动备份保留最近5个版本
- 重要修改前手动创建完整备份
- 定期导出整个模板套装

### 4. 回滚方案

**出现问题时的恢复步骤：**

1. **从自动备份恢复：**
   - 在文件列表中找到备份文件
   - 复制备份文件内容
   - 粘贴到主文件并保存

2. **从回收站恢复：**
   - 访问服务器 `templates/.trash/` 目录
   - 找到对应的备份文件
   - 恢复到原位置

3. **从外部备份恢复：**
   - 通过FTP上传备份文件
   - 覆盖当前文件

## 常见问题

### Q1: 编辑器不显示内容？

**A:** 检查以下几点：
- 文件是否存在
- 模板套装是否正确
- 是否有读取权限

### Q2: 保存失败？

**A:** 可能的原因：
- 文件目录没有写入权限
- 文件被其他程序占用
- 磁盘空间不足

**解决方法：**
```bash
# 检查权限
ls -la /path/to/templates/

# 设置权限
chmod 755 /path/to/templates/
chown www-data:www-data /path/to/templates/ -R
```

### Q3: 修改后前端没有更新？

**A:** 需要清理缓存：
1. 访问"缓存管理"页面
2. 点击"清除模板缓存"
3. 刷新前端页面

### Q4: 删除的文件如何恢复？

**A:** 两种方法：
1. 从 `templates/.trash/` 目录恢复
2. 从自动备份恢复（如果删除前有打开过）

### Q5: 如何批量修改多个文件？

**A:** 目前需要逐个文件修改，建议：
- 使用文本编辑器的查找替换功能
- 或通过FTP批量下载编辑后上传

## 技术支持

如有问题，请：
1. 查看本文档
2. 检查操作日志
3. 查看系统日志
4. 提交Issue：https://github.com/carefree-code/CarefreeCMS/issues

---

**版本**: 1.1.0
**最后更新**: 2025-10-21
