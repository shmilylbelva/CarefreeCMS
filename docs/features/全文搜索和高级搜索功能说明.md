# 全文搜索和高级搜索功能说明

## 功能概述

本次更新为 CMS 系统添加了强大的全文搜索和高级搜索功能，支持多种搜索模式和丰富的筛选条件。

## 主要特性

### 1. 全文搜索（Full-Text Search）

利用 MySQL 的 FULLTEXT INDEX 功能，提供高性能的内容搜索。

#### 支持的搜索模式

- **自然语言模式（Natural Language Mode）**
  - 默认模式，适合大多数搜索场景
  - 根据相关度自动排序结果
  - 示例：搜索 "Vue 开发教程"

- **布尔模式（Boolean Mode）**
  - 支持高级搜索操作符
  - `+word`：必须包含该词
  - `-word`：必须不包含该词
  - `"phrase"`：精确短语匹配
  - 示例：`+Vue -React "前端开发"`

- **查询扩展模式（Query Expansion）**
  - 自动扩展相关词汇
  - 提高搜索召回率
  - 适合专业术语搜索

#### 全文搜索特性

✅ 搜索文章标题和内容
✅ 按相关度排序
✅ 搜索结果高亮显示
✅ 支持分类和状态筛选
✅ 支持时间范围筛选
✅ 自动完成/搜索建议
✅ 搜索历史记录（本地存储）

### 2. 高级搜索（Advanced Search）

提供更精细的多字段组合搜索功能。

#### 支持的搜索字段

- **文本字段**
  - 标题（title）
  - 内容（content）
  - 摘要（summary）
  - 作者名称（author）

- **分类和标签**
  - 按分类筛选（支持主分类和副分类）
  - 按标签筛选（支持多选）

- **文章属性**
  - 状态（草稿/已发布/待审核/已下线）
  - 置顶文章
  - 推荐文章
  - 热门文章

- **数值范围**
  - 发布时间范围
  - 浏览量范围（最小值-最大值）

- **排序选项**
  - 发布时间
  - 浏览量
  - 点赞数
  - 评论数
  - 创建时间
  - 更新时间
  - 排序方向（升序/降序）

### 3. 搜索建议（Auto-complete）

- 实时搜索建议
- 基于文章标题匹配
- 显示浏览量统计
- 按热门程度排序

### 4. 搜索历史

- 自动保存最近 10 次搜索
- 一键重新执行历史搜索
- 支持删除单条历史
- 支持清空所有历史
- 使用 localStorage 存储

### 5. 搜索结果高亮

- 自动高亮匹配的关键词
- 高亮显示标题中的关键词
- 高亮显示摘要中的关键词
- 醒目的黄色背景标记

## API 接口

### 1. 全文搜索

**端点**：`GET /backend/articles/fulltext-search`

**参数**：
```json
{
  "keyword": "搜索关键词（必填）",
  "mode": "natural|boolean|query_expansion（默认：natural）",
  "category_id": "分类ID（可选）",
  "status": "状态值（可选）",
  "start_time": "开始日期（可选）",
  "end_time": "结束日期（可选）",
  "page": "页码（默认：1）",
  "page_size": "每页数量（默认：20）"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "title": "Vue 3 开发教程",
        "highlighted_title": "Vue 3 开发<mark>教程</mark>",
        "highlighted_summary": "本文介绍 Vue 3 的核心<mark>教程</mark>...",
        "relevance_score": 1.5,
        ...
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
  }
}
```

### 2. 高级搜索

**端点**：`GET /backend/articles/advanced-search`

**参数**：
```json
{
  "title": "标题关键词（可选）",
  "content": "内容关键词（可选）",
  "summary": "摘要关键词（可选）",
  "author": "作者名称（可选）",
  "category_id": "分类ID（可选）",
  "tag_ids": "标签ID，逗号分隔（可选）",
  "user_id": "用户ID（可选）",
  "status": "状态值（可选）",
  "is_top": "是否置顶（可选）",
  "is_recommend": "是否推荐（可选）",
  "is_hot": "是否热门（可选）",
  "start_time": "开始日期（可选）",
  "end_time": "结束日期（可选）",
  "min_views": "最小浏览量（可选）",
  "max_views": "最大浏览量（可选）",
  "sort_by": "排序字段（默认：publish_time）",
  "sort_order": "排序方向（默认：desc）",
  "page": "页码（默认：1）",
  "page_size": "每页数量（默认：20）"
}
```

### 3. 搜索建议

**端点**：`GET /backend/articles/search-suggestions`

**参数**：
```json
{
  "keyword": "搜索关键词（必填）",
  "limit": "返回数量（默认：10）"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "title": "Vue 3 开发教程",
      "view_count": 1520
    },
    ...
  ]
}
```

## 前端使用

### 1. 打开高级搜索对话框

在文章列表页面，点击"高级搜索"按钮即可打开搜索对话框。

### 2. 全文搜索

1. 在对话框中选择"全文搜索"标签页
2. 输入搜索关键词（支持自动完成）
3. 选择搜索模式（可选）
4. 设置额外的筛选条件（可选）
5. 点击"搜索"按钮

### 3. 高级搜索

1. 在对话框中选择"高级搜索"标签页
2. 填写需要搜索的字段
3. 设置筛选条件和排序方式
4. 点击"搜索"按钮

### 4. 使用搜索历史

- 在全文搜索标签页可以看到"搜索历史"区域
- 点击历史记录标签可快速填充关键词
- 点击标签上的 × 可删除单条历史
- 点击"清空历史"可删除所有历史记录

### 5. 查看搜索结果

- 搜索完成后，页面顶部会显示搜索条件提示
- 搜索结果中的关键词会以黄色高亮显示
- 可以点击提示框的 × 清除搜索，返回普通列表

## 使用场景示例

### 场景 1：查找包含特定关键词的文章

使用**全文搜索 - 自然语言模式**：
- 关键词：`Vue 组件开发`
- 系统会搜索标题和内容中包含这些词的文章
- 按相关度排序

### 场景 2：查找必须包含某词但不包含另一词的文章

使用**全文搜索 - 布尔模式**：
- 关键词：`+React -Vue`
- 查找包含 React 但不包含 Vue 的文章

### 场景 3：查找特定分类下浏览量高的文章

使用**高级搜索**：
- 分类：选择目标分类
- 最小浏览量：1000
- 排序方式：按浏览量降序

### 场景 4：查找特定作者在特定时间段发布的文章

使用**高级搜索**：
- 作者：输入作者名称
- 发布时间：选择时间范围
- 状态：已发布

### 场景 5：查找标题包含特定词且带有多个标签的文章

使用**高级搜索**：
- 标题：输入关键词
- 标签：选择多个标签
- 文章属性：勾选"推荐"

## 技术实现

### 后端（PHP/ThinkPHP）

**文件位置**：
- 控制器：`backend/app/controller/backend/Article.php`
- 路由配置：`backend/route/api.php`

**核心方法**：
- `fullTextSearch()` - 全文搜索
- `advancedSearch()` - 高级搜索
- `searchSuggestions()` - 搜索建议
- `highlightKeyword()` - 关键词高亮

**使用的技术**：
- MySQL FULLTEXT INDEX
- ThinkPHP ORM 查询构造器
- 正则表达式高亮
- 复杂 SQL 子查询

### 前端（Vue 3）

**文件位置**：
- 组件：`frontend/src/components/AdvancedSearch.vue`
- 页面：`frontend/src/views/article/List.vue`
- API：`frontend/src/backend/article.js`

**核心功能**：
- Element Plus 组件库
- 响应式表单
- localStorage 存储
- 自动完成组件
- v-html 渲染高亮内容

## 注意事项

### 1. 全文索引限制

- MySQL 全文搜索需要数据库已创建 FULLTEXT INDEX
- 默认情况下，单词长度需要 ≥ 4 个字符（英文）
- 中文需要安装 ngram 分词插件
- 停用词（如 "the", "a"）会被忽略

### 2. 性能优化建议

- 全文搜索性能优于 LIKE 查询
- 建议对大表使用分页
- 可以设置缓存来提高频繁搜索的性能
- 定期优化数据库表

### 3. 安全考虑

- 所有输入都经过过滤和转义
- 防止 SQL 注入
- XSS 防护（v-html 需谨慎使用）
- 限制搜索频率（建议在生产环境添加）

### 4. 浏览器兼容性

- 支持所有现代浏览器
- localStorage 需要浏览器支持
- 建议使用最新版 Chrome、Firefox、Edge

## 测试清单

### 后端测试

- [ ] 测试全文搜索 - 自然语言模式
- [ ] 测试全文搜索 - 布尔模式
- [ ] 测试全文搜索 - 查询扩展模式
- [ ] 测试高级搜索 - 单一条件
- [ ] 测试高级搜索 - 多个条件组合
- [ ] 测试搜索建议 API
- [ ] 测试分页功能
- [ ] 测试排序功能
- [ ] 验证数据安全性

### 前端测试

- [ ] 打开高级搜索对话框
- [ ] 测试全文搜索表单提交
- [ ] 测试高级搜索表单提交
- [ ] 测试搜索建议/自动完成
- [ ] 测试搜索历史保存
- [ ] 测试搜索历史加载
- [ ] 测试搜索历史删除
- [ ] 验证搜索结果高亮显示
- [ ] 测试清除搜索功能
- [ ] 测试表单重置功能

## 故障排查

### 问题 1：全文搜索无结果

**可能原因**：
- 数据库未创建 FULLTEXT INDEX
- 搜索词太短（< 4 个字符）
- 搜索词是停用词

**解决方案**：
```sql
-- 检查索引
SHOW INDEX FROM articles;

-- 创建全文索引（如果不存在）
ALTER TABLE articles ADD FULLTEXT INDEX ft_title_content (title, content);
```

### 问题 2：搜索建议不显示

**可能原因**：
- API 请求失败
- 没有匹配的文章
- 只搜索已发布的文章

**解决方案**：
- 检查浏览器控制台网络请求
- 确保有已发布的文章
- 检查 API 路由是否正确

### 问题 3：搜索历史丢失

**可能原因**：
- 浏览器清除了 localStorage
- 隐私模式下不保存
- 浏览器不支持 localStorage

**解决方案**：
- 这是正常行为，搜索历史存储在本地
- 避免在隐私模式下使用
- 升级到支持 HTML5 的浏览器

### 问题 4：高亮显示不正确

**可能原因**：
- 后端未返回高亮字段
- v-html 渲染问题
- CSS 样式冲突

**解决方案**：
- 检查 API 响应中的 `highlighted_title` 和 `highlighted_summary` 字段
- 检查 `<mark>` 标签的 CSS 样式
- 确保使用 v-html 而不是普通文本绑定

## 未来改进建议

1. **搜索性能**
   - 添加 Redis 缓存热门搜索
   - 实现搜索结果缓存
   - 异步索引更新

2. **搜索体验**
   - 添加搜索热词推荐
   - 支持拼音搜索
   - 模糊匹配优化
   - 搜索统计分析

3. **高级功能**
   - 保存搜索条件为模板
   - 定期搜索提醒
   - 搜索结果导出
   - 批量操作搜索结果

4. **前端优化**
   - 搜索去抖动（debounce）
   - 无限滚动加载
   - 搜索结果预览
   - 快捷键支持

## 总结

本次更新为 CMS 系统添加了完善的全文搜索和高级搜索功能，大大提升了内容管理的效率。通过合理使用这些功能，可以快速定位和管理文章内容。

如有问题或建议，欢迎反馈！
