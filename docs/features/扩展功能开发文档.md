# CMS扩展功能开发文档

## 概述

本文档介绍CMS系统的5大扩展功能模块的开发情况、使用方法和API接口。

### 已完成的功能模块

1. **消息通知系统** - 站内消息、邮件、短信多渠道通知
2. **手机验证与短信服务** - 验证码发送、短信服务集成
3. **积分商城** - 积分兑换商品、订单管理
4. **投稿系统** - 用户投稿、审核workflow
5. **第三方登录** - OAuth配置基础（预留接口）

---

## 一、消息通知系统

### 1.1 功能特点

- **多渠道支持**：站内消息、邮件、短信
- **消息模板**：可配置的消息模板系统
- **用户设置**：用户可自定义接收渠道
- **通知分类**：系统通知、评论、点赞、关注、回复、审核、订单等

### 1.2 数据库表

- `notifications` - 站内消息表
- `notification_templates` - 消息模板表
- `user_notification_settings` - 用户通知设置表

### 1.3 核心文件

**模型：**
- `app/model/Notification.php` - 通知模型
- `app/model/NotificationTemplate.php` - 模板模型
- `app/model/UserNotificationSetting.php` - 用户设置模型

**服务：**
- `app/service/NotificationService.php` - 通知服务类

**控制器：**
- `app/controller/backend/NotificationController.php` - 前台通知接口
- `app/controller/backend/NotificationManage.php` - 后台管理接口

### 1.4 API接口

#### 前台接口

```
GET    /backend/notification/index            # 通知列表
GET    /backend/notification/unreadCount      # 未读数量
GET    /backend/notification/read/{id}        # 通知详情（自动标记已读）
POST   /backend/notification/markAsRead       # 标记已读
POST   /backend/notification/markAllAsRead    # 全部标记已读
DELETE /backend/notification/delete/{id}      # 删除通知
POST   /backend/notification/batchDelete      # 批量删除
POST   /backend/notification/clearRead        # 清空已读
GET    /backend/notification/getSettings      # 获取通知设置
POST   /backend/notification/updateSettings   # 更新通知设置
```

#### 后台接口

```
GET    /backend/notification-manage/templateIndex               # 模板列表
GET    /backend/notification-manage/templateRead/{id}           # 模板详情
POST   /backend/notification-manage/templateCreate              # 创建模板
PUT    /backend/notification-manage/templateUpdate/{id}         # 更新模板
DELETE /backend/notification-manage/templateDelete/{id}         # 删除模板
POST   /backend/notification-manage/sendSystemNotification      # 发送系统通知（全员）
POST   /backend/notification-manage/sendToUser                  # 发送给指定用户
POST   /backend/notification-manage/cleanOldNotifications       # 清理旧通知
```

### 1.5 使用示例

**发送站内通知：**

```php
use app\service\NotificationService;

// 发送普通通知
NotificationService::send(
    $userId,
    'system',
    '系统通知标题',
    '这是通知内容',
    [
        'link' => '/article/123',
        'from_user_id' => 1,
    ]
);

// 使用模板发送
NotificationService::sendByTemplate(
    $userId,
    'comment_reply',
    [
        'from_user' => '张三',
        'content' => '回复内容',
    ]
);

// 发送文章审核通知
NotificationService::sendArticleAuditNotification(
    $userId,
    '文章标题',
    true,  // 是否通过
    '审核备注'
);
```

---

## 二、手机验证与短信服务

### 2.1 功能特点

- **验证码管理**：手机/邮箱验证码生成、验证
- **发送频率限制**：60秒内只能发送一次，每天最多10次
- **多服务商支持**：阿里云、腾讯云、云片
- **模拟发送**：开发环境自动使用模拟发送
- **完整日志**：记录所有发送日志和成功率统计

### 2.2 数据库表

- `sms_config` - 短信服务配置表
- `sms_templates` - 短信模板表
- `sms_logs` - 短信发送日志表
- `verify_codes` - 验证码表

### 2.3 核心文件

**模型：**
- `app/model/SmsConfig.php`
- `app/model/SmsTemplate.php`
- `app/model/SmsLog.php`
- `app/model/VerifyCode.php`

**服务：**
- `app/service/SmsService.php` - 短信发送服务
- `app/service/VerifyCodeService.php` - 验证码服务

**控制器：**
- `app/controller/backend/VerifyCodeController.php` - 前台验证码接口
- `app/controller/backend/SmsManage.php` - 后台短信管理

### 2.4 API接口

#### 前台接口

```
POST /backend/verify-code/sendPhoneCode     # 发送手机验证码
POST /backend/verify-code/sendEmailCode     # 发送邮箱验证码
POST /backend/verify-code/verifyPhoneCode   # 验证手机验证码
POST /backend/verify-code/verifyEmailCode   # 验证邮箱验证码
```

#### 后台接口

```
GET    /backend/sms-manage/configIndex              # 短信配置列表
POST   /backend/sms-manage/configCreate             # 创建配置
PUT    /backend/sms-manage/configUpdate/{id}        # 更新配置
DELETE /backend/sms-manage/configDelete/{id}        # 删除配置
GET    /backend/sms-manage/templateIndex            # 模板列表
POST   /backend/sms-manage/templateCreate           # 创建模板
PUT    /backend/sms-manage/templateUpdate/{id}      # 更新模板
DELETE /backend/sms-manage/templateDelete/{id}      # 删除模板
GET    /backend/sms-manage/logIndex                 # 短信日志
GET    /backend/sms-manage/statistics               # 发送统计
GET    /backend/sms-manage/verifyCodeIndex          # 验证码列表
POST   /backend/sms-manage/cleanExpiredCodes        # 清理过期验证码
```

### 2.5 使用示例

**发送验证码：**

```php
use app\service\VerifyCodeService;

// 发送手机验证码
$result = VerifyCodeService::sendPhoneCode('13800138000', 'register');

// 验证验证码
$valid = VerifyCodeService::verifyPhoneCode('13800138000', '123456', 'register');
```

**配置短信服务商：**

需要在数据库 `sms_config` 表中配置服务商信息：

```sql
INSERT INTO sms_config (provider, access_key, access_secret, sign_name, status, is_default)
VALUES ('aliyun', 'your_key', 'your_secret', '您的签名', 1, 1);
```

---

## 三、积分商城

### 3.1 功能特点

- **商品分类**：支持多级分类
- **商品类型**：虚拟商品、实物商品
- **库存管理**：支持有限库存和无限库存
- **兑换限制**：等级限制、VIP限制、个人限兑
- **订单流程**：待发货 → 已发货 → 已完成
- **自动发货**：虚拟商品自动发货并完成
- **积分退还**：取消订单自动退还积分

### 3.2 数据库表

- `point_shop_categories` - 商城分类表
- `point_shop_goods` - 商品表
- `point_shop_orders` - 订单表

### 3.3 核心文件

**模型：**
- `app/model/PointShopCategory.php`
- `app/model/PointShopGoods.php`
- `app/model/PointShopOrder.php`

**服务：**
- `app/service/PointShopService.php`

**控制器：**
- `app/controller/backend/PointShop.php` - 前台商城接口
- `app/controller/backend/PointShopManage.php` - 后台管理接口

### 3.4 API接口

#### 前台接口

```
GET  /backend/point-shop/categoryList           # 分类列表
GET  /backend/point-shop/goodsList              # 商品列表
GET  /backend/point-shop/goodsDetail/{id}       # 商品详情
POST /backend/point-shop/exchange               # 兑换商品
GET  /backend/point-shop/myOrders               # 我的订单
GET  /backend/point-shop/orderDetail/{id}       # 订单详情
POST /backend/point-shop/cancelOrder/{id}       # 取消订单
GET  /backend/point-shop/myStatistics           # 我的统计
```

#### 后台接口

**分类管理：**
```
GET    /backend/point-shop-manage/categoryIndex              # 分类列表
POST   /backend/point-shop-manage/categoryCreate             # 创建分类
PUT    /backend/point-shop-manage/categoryUpdate/{id}        # 更新分类
DELETE /backend/point-shop-manage/categoryDelete/{id}        # 删除分类
```

**商品管理：**
```
GET    /backend/point-shop-manage/goodsIndex           # 商品列表
GET    /backend/point-shop-manage/goodsRead/{id}       # 商品详情
POST   /backend/point-shop-manage/goodsCreate          # 创建商品
PUT    /backend/point-shop-manage/goodsUpdate/{id}     # 更新商品
DELETE /backend/point-shop-manage/goodsDelete/{id}     # 删除商品
```

**订单管理：**
```
GET  /backend/point-shop-manage/orderIndex              # 订单列表
GET  /backend/point-shop-manage/orderRead/{id}          # 订单详情
POST /backend/point-shop-manage/orderDeliver/{id}       # 发货
POST /backend/point-shop-manage/orderComplete/{id}      # 完成订单
POST /backend/point-shop-manage/orderCancel/{id}        # 取消订单
GET  /backend/point-shop-manage/statistics              # 统计信息
```

### 3.5 使用示例

**创建商品：**

```php
use app\model\PointShopGoods;

$goods = PointShopGoods::create([
    'category_id' => 1,
    'name' => 'VIP会员月卡',
    'description' => '享受30天VIP特权',
    'price' => 500,           // 所需积分
    'stock' => -1,            // -1表示无限库存
    'type' => 'virtual',      // 虚拟商品
    'virtual_content' => '兑换码：XXXXX',
    'level_required' => 2,    // 需要2级
    'vip_required' => 0,      // 不需要VIP
    'limit_per_user' => 1,    // 每人限兑1次
    'status' => 1,
]);
```

**用户兑换商品：**

```php
use app\service\PointShopService;

$result = PointShopService::exchange(
    $userId,
    $goodsId,
    1,  // 数量
    [
        'name' => '张三',
        'phone' => '13800138000',
        'address' => '北京市朝阳区xxx',
    ]
);
```

---

## 四、投稿系统

### 4.1 功能特点

- **分类配置**：每个分类可单独配置投稿规则
- **投稿限制**：等级限制、字数限制、每日限制
- **审核流程**：可配置是否需要审核
- **积分奖励**：审核通过自动奖励积分
- **消息通知**：审核结果自动通知用户

### 4.2 数据库表

- `contribute_config` - 投稿配置表
- `articles` 表扩展字段：
  - `is_contribute` - 是否投稿
  - `audit_status` - 审核状态（0待审核/1已通过/2已拒绝）
  - `audit_user_id` - 审核人ID
  - `audit_time` - 审核时间
  - `audit_remark` - 审核备注
  - `reward_points` - 奖励积分

### 4.3 核心文件

**模型：**
- `app/model/ContributeConfig.php` - 投稿配置模型
- `app/model/Article.php` - 文章模型（已扩展）

**服务：**
- `app/service/ContributeService.php` - 投稿服务

**控制器：**
- `app/controller/backend/Contribute.php` - 前台投稿接口
- `app/controller/backend/ContributeManage.php` - 后台审核管理

### 4.4 API接口

#### 前台接口

```
GET    /backend/contribute/categories          # 获取可投稿分类列表
POST   /backend/contribute/submit              # 提交投稿
GET    /backend/contribute/myContributions     # 我的投稿列表
GET    /backend/contribute/detail/{id}         # 投稿详情
DELETE /backend/contribute/delete/{id}         # 删除投稿（未通过审核的）
```

#### 后台接口

```
GET  /backend/contribute-manage/index                # 投稿列表
GET  /backend/contribute-manage/read/{id}            # 投稿详情
POST /backend/contribute-manage/auditPass/{id}       # 审核通过
POST /backend/contribute-manage/auditReject/{id}     # 审核拒绝
DELETE /backend/contribute-manage/delete/{id}        # 删除投稿
GET  /backend/contribute-manage/configIndex          # 配置列表
POST /backend/contribute-manage/configCreate         # 创建配置
PUT  /backend/contribute-manage/configUpdate/{id}    # 更新配置
GET  /backend/contribute-manage/statistics           # 投稿统计
```

### 4.5 使用示例

**配置投稿规则：**

```php
use app\model\ContributeConfig;

$config = ContributeConfig::create([
    'category_id' => 1,
    'allow_contribute' => 1,     // 允许投稿
    'need_audit' => 1,           // 需要审核
    'reward_points' => 50,       // 通过后奖励50积分
    'min_words' => 300,          // 最少300字
    'max_per_day' => 3,          // 每天最多3篇
    'level_required' => 2,       // 需要2级
]);
```

**用户投稿：**

```php
use app\service\ContributeService;

$result = ContributeService::submit($userId, [
    'title' => '文章标题',
    'content' => '文章内容...',
    'category_id' => 1,
    'cover_image' => 'uploads/xxx.jpg',
]);
```

**审核投稿：**

```php
use app\model\Article;

$article = Article::find($id);

// 通过
$article->auditPass($auditorId, '文章质量很好');

// 拒绝
$article->auditReject($auditorId, '内容不符合规范');
```

---

## 五、第三方登录（预留接口）

### 5.1 功能说明

已创建OAuth配置基础表和扩展用户表字段，为第三方登录功能预留接口。

### 5.2 数据库表

- `oauth_config` - OAuth配置表
- `front_users` 表扩展字段：
  - `wechat_openid` - 微信OpenID
  - `qq_openid` - QQ OpenID
  - `weibo_uid` - 微博UID
  - `github_id` - GitHub ID

### 5.3 待实现

具体实现需要引入各平台的SDK：

- **微信登录**：微信开放平台SDK
- **QQ登录**：QQ互联SDK
- **微博登录**：微博开放平台SDK
- **GitHub登录**：GitHub OAuth Apps

---

## 测试脚本

为确保系统稳定运行，已提供完整的测试脚本：

```bash
# 测试通知系统
php test-notification-system.php

# 测试短信验证系统
php test-sms-system.php

# 测试积分商城
php test-point-shop.php

# 测试前台用户系统
php test-user-system.php
```

---

## 数据库初始化

**创建扩展功能表：**

```bash
php database/create-extension-tables.php
```

该脚本会自动创建所有扩展功能需要的数据库表，并初始化基础数据。

---

## 技术栈

- **后端框架**：ThinkPHP 8.0
- **认证方式**：JWT Token
- **数据库**：MySQL 5.7+
- **PHP版本**：PHP 7.4+

---

## 开发规范

### 1. 代码结构

```
backend/
├── app/
│   ├── controller/backend/      # 控制器
│   ├── model/               # 模型
│   ├── service/             # 业务逻辑服务层
│   ├── middleware/          # 中间件
│   └── common/              # 公共类
├── database/                # 数据库文件
└── test-*.php              # 测试脚本
```

### 2. 响应格式

所有API统一使用 `Response` 类返回：

```php
// 成功响应
Response::success($data, '操作成功');

// 错误响应
Response::error('错误信息');

// 404响应
Response::notFound('资源不存在');
```

### 3. 认证中间件

需要登录的接口使用 `AuthMiddleware`：

```php
protected $middleware = [
    AuthMiddleware::class => ['except' => ['index', 'detail']],
];
```

---

## 注意事项

1. **积分操作**：所有积分操作都会记录日志，使用 `addPoints()` 和 `deductPoints()` 方法

2. **软删除**：用户、文章等支持软删除，已删除数据可恢复

3. **事务处理**：涉及多表操作的业务使用数据库事务确保一致性

4. **安全性**：
   - 所有用户输入都需要验证
   - 敏感操作需要权限检查
   - 密码使用 `password_hash()` 加密
   - JWT Token设置合理的过期时间

5. **性能优化**：
   - 合理使用索引
   - 避免N+1查询问题
   - 使用 `with()` 预加载关联数据

---

## 联系方式

如有问题或建议，请联系开发团队。

---

**文档版本**：v1.0
**最后更新**：2025-11-01
**开发者**：Claude Code
