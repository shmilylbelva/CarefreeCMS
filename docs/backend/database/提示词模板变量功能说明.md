# 提示词模板变量功能说明

**更新时间**: 2025-01-14

---

## 📋 功能概述

提示词模板变量功能允许在创建AI生成任务时，动态填写模板中的参数，避免传递给AI的提示词中包含未替换的占位符（如 `{word_count}` 等）。

---

## 🎯 功能说明

### 变量占位符格式

在提示词模板中使用 **单花括号** `{变量名}` 作为占位符：

```
请撰写一篇关于{topic}的文章，字数要求{word_count}字，写作风格采用{writing_style}。
```

### 自动变量替换流程

1. **创建任务时**：用户选择提示词模板
2. **解析变量**：系统自动检测模板中定义的变量
3. **动态显示表单**：根据变量类型生成相应的输入控件
4. **用户填写**：用户填写或选择变量值
5. **提交任务**：变量值保存到 `prompt_variables` 字段
6. **生成文章时**：后端将占位符替换为实际值后再发送给AI

---

## 🔧 模板变量定义

### 数据库字段

**表**: `ai_prompt_templates`
**字段**: `variables` (JSON类型)

### 变量定义格式

```json
[
  {
    "name": "word_count",
    "label": "字数要求",
    "type": "number",
    "default": 1000,
    "placeholder": "请输入文章字数",
    "required": true
  },
  {
    "name": "writing_style",
    "label": "写作风格",
    "type": "select",
    "options": ["专业", "轻松", "学术"],
    "default": "专业",
    "required": true
  },
  {
    "name": "target_audience",
    "label": "目标读者",
    "type": "text",
    "placeholder": "如：技术人员、普通用户",
    "required": false
  }
]
```

### 变量属性说明

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | ✅ | 变量名称（用于占位符和存储） |
| label | string | ✅ | 显示标签（表单中显示的名称） |
| type | string | ✅ | 输入类型：text/number/textarea/select |
| default | any | ❌ | 默认值（用户不填时使用） |
| placeholder | string | ❌ | 输入提示文字 |
| required | boolean | ❌ | 是否必填（默认false） |
| options | array | ❌ | 选项列表（type=select时必需） |

### 支持的输入类型

#### 1. text - 单行文本
```json
{
  "name": "keyword",
  "label": "关键词",
  "type": "text",
  "placeholder": "请输入关键词",
  "required": true
}
```
**前端显示**: `<el-input>`

#### 2. number - 数字
```json
{
  "name": "word_count",
  "label": "字数",
  "type": "number",
  "default": 1000,
  "required": true
}
```
**前端显示**: `<el-input-number>`

#### 3. textarea - 多行文本
```json
{
  "name": "requirements",
  "label": "具体要求",
  "type": "textarea",
  "placeholder": "请输入详细要求",
  "required": false
}
```
**前端显示**: `<el-input type="textarea" :rows="3">`

#### 4. select - 下拉选择
```json
{
  "name": "tone",
  "label": "语气",
  "type": "select",
  "options": ["正式", "友好", "幽默"],
  "default": "正式",
  "required": true
}
```
**前端显示**: `<el-select>`

---

## 📝 创建带变量的模板示例

### 示例1：SEO文章模板

**提示词内容**:
```
请撰写一篇关于{topic}的SEO优化文章。

要求：
- 字数：{word_count}字
- 关键词密度：{keyword_density}%
- 目标关键词：{target_keyword}
- 写作风格：{writing_style}

请确保文章结构清晰，包含引言、正文（多个小节）和结论。
```

**变量定义** (variables字段):
```json
[
  {
    "name": "word_count",
    "label": "文章字数",
    "type": "number",
    "default": 1500,
    "required": true
  },
  {
    "name": "keyword_density",
    "label": "关键词密度(%)",
    "type": "number",
    "default": 2,
    "required": true
  },
  {
    "name": "target_keyword",
    "label": "目标关键词",
    "type": "text",
    "placeholder": "请输入目标关键词",
    "required": true
  },
  {
    "name": "writing_style",
    "label": "写作风格",
    "type": "select",
    "options": ["专业严谨", "通俗易懂", "轻松幽默"],
    "default": "专业严谨",
    "required": true
  }
]
```

### 示例2：产品介绍模板

**提示词内容**:
```
请为{product_name}撰写一篇产品介绍文章。

产品信息：
- 产品名称：{product_name}
- 产品类型：{product_type}
- 目标用户：{target_audience}
- 核心卖点：{key_features}

字数要求：{word_count}字
写作风格：{tone}

请突出产品的核心优势，使用吸引人的语言。
```

**变量定义**:
```json
[
  {
    "name": "product_name",
    "label": "产品名称",
    "type": "text",
    "required": true
  },
  {
    "name": "product_type",
    "label": "产品类型",
    "type": "select",
    "options": ["软件", "硬件", "服务", "其他"],
    "default": "软件",
    "required": true
  },
  {
    "name": "target_audience",
    "label": "目标用户",
    "type": "text",
    "placeholder": "如：企业用户、个人用户",
    "required": true
  },
  {
    "name": "key_features",
    "label": "核心卖点",
    "type": "textarea",
    "placeholder": "每行一个卖点",
    "required": true
  },
  {
    "name": "word_count",
    "label": "字数",
    "type": "number",
    "default": 800,
    "required": true
  },
  {
    "name": "tone",
    "label": "语气风格",
    "type": "select",
    "options": ["专业正式", "友好亲切", "创新科技"],
    "default": "友好亲切",
    "required": true
  }
]
```

---

## 🖥️ 前端实现

### 1. 模板选择时的处理

当用户选择提示词模板时，系统会：

```javascript
// 1. 解析 variables 字段（兼容字符串和对象格式）
let vars = template.variables
if (typeof vars === 'string') {
  vars = JSON.parse(vars)
}

// 2. 为每个变量设置默认值
vars.forEach(v => {
  if (v.default && !form.prompt_variables[v.name]) {
    form.prompt_variables[v.name] = v.default
  }
})

// 3. 动态生成表单字段
return vars
```

### 2. 动态表单显示

```vue
<!-- 醒目的提示框 -->
<el-alert
  v-if="templateVariables.length > 0"
  title="请填写以下模板参数"
  description="这些参数将用于替换提示词模板中的占位符，确保生成准确的内容"
  type="warning"
/>

<!-- 根据变量类型动态生成输入框 -->
<el-form-item
  v-for="variable in templateVariables"
  :key="variable.name"
  :label="variable.label"
  :required="variable.required"
>
  <!-- text -->
  <el-input v-if="variable.type === 'text'"
    v-model="form.prompt_variables[variable.name]"
    :placeholder="variable.placeholder"
  />

  <!-- number -->
  <el-input-number v-else-if="variable.type === 'number'"
    v-model="form.prompt_variables[variable.name]"
  />

  <!-- textarea -->
  <el-input v-else-if="variable.type === 'textarea'"
    v-model="form.prompt_variables[variable.name]"
    type="textarea"
    :rows="3"
  />

  <!-- select -->
  <el-select v-else-if="variable.type === 'select'"
    v-model="form.prompt_variables[variable.name]"
  >
    <el-option
      v-for="option in variable.options"
      :key="option"
      :label="option"
      :value="option"
    />
  </el-select>
</el-form-item>
```

### 3. 提交时的数据结构

```javascript
// 提交给后端的数据
{
  title: "任务名称",
  topic: "主题1\n主题2\n主题3",
  prompt_template_id: 1,
  prompt_variables: {
    word_count: 1500,
    keyword_density: 2,
    target_keyword: "人工智能",
    writing_style: "专业严谨"
  },
  ai_config_id: 1,
  settings: {
    length: "medium",
    style: "professional"
  }
}
```

---

## 🔧 后端实现

### 1. 变量替换逻辑

**文件**: `backend/app/service/AiArticleGeneratorService.php`
**方法**: `buildPromptFromTemplate()`

```php
private function buildPromptFromTemplate(AiArticleTask $task, $currentTopic)
{
    $template = $task->promptTemplate;
    if (!$template) {
        return $currentTopic;
    }

    $prompt = $template->prompt;
    $userVariables = $task->prompt_variables ?? [];

    // 将当前主题作为topic变量（内置变量）
    $userVariables['topic'] = $currentTopic;

    // 获取模板定义的变量及其默认值
    $templateVariables = [];
    if ($template->variables) {
        $varDefs = is_array($template->variables)
            ? $template->variables
            : json_decode($template->variables, true);

        foreach ($varDefs as $varDef) {
            $varName = $varDef['name'];
            // 优先使用用户填写的值，否则使用默认值
            if (!isset($userVariables[$varName]) || $userVariables[$varName] === '') {
                if (isset($varDef['default'])) {
                    $templateVariables[$varName] = $varDef['default'];
                }
            } else {
                $templateVariables[$varName] = $userVariables[$varName];
            }
        }
    }

    // 确保topic始终存在
    $templateVariables['topic'] = $currentTopic;

    // 替换变量（使用单花括号）
    foreach ($templateVariables as $key => $value) {
        $stringValue = $value === null ? '' : (string)$value;
        $prompt = str_replace('{' . $key . '}', $stringValue, $prompt);
    }

    return $prompt;
}
```

### 2. 内置变量

系统自动提供的变量，无需在 variables 中定义：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| {topic} | 当前文章主题 | "人工智能的发展趋势" |

**使用示例**:
```
请撰写一篇关于{topic}的文章，字数{word_count}字。
```
批量生成时，每个主题会自动替换 `{topic}` 变量。

---

## ✨ 用户使用流程

### 管理员：创建模板

1. 进入"提示词模板管理"
2. 点击"添加模板"
3. 填写模板信息：
   - 名称：SEO文章生成模板
   - 分类：SEO文章
   - 提示词内容：（包含 `{变量名}` 占位符）
   - **变量定义**：（JSON格式，定义每个变量的属性）
4. 保存模板

### 用户：使用模板创建任务

1. 进入"AI文章生成任务"
2. 点击"创建任务"
3. 选择"提示词模板"
4. **系统自动显示模板参数输入框**（黄色警告框提醒）
5. 填写每个参数的值：
   - 文章字数：1500
   - 关键词密度：2
   - 目标关键词：人工智能
   - 写作风格：专业严谨
6. 填写文章主题（每行一个）
7. 选择AI配置
8. 提交任务

### 系统：生成文章

1. 任务启动后，对每个主题：
   - 读取模板提示词
   - 将 `{topic}` 替换为当前主题
   - 将其他变量替换为用户填写的值
   - 发送给AI生成文章
2. 用户查看生成记录时，可以在"调试信息"中看到：
   - 原始主题
   - 实际发送的提示词（已替换所有变量）

---

## ⚠️ 常见问题

### 1. 变量输入框没有显示

**原因**:
- 模板的 `variables` 字段为空或格式错误
- JSON格式不正确

**解决方法**:
```sql
-- 检查模板的variables字段
SELECT id, name, variables FROM ai_prompt_templates WHERE id = 1;

-- 正确的格式应该是JSON数组
-- 错误：NULL, "", "[]", 字符串格式错误
-- 正确：[{"name":"word_count","label":"字数","type":"number"}]
```

### 2. AI返回的内容还包含占位符

**原因**:
- 用户没有填写某个变量的值
- 变量没有默认值
- 变量名称不匹配（模板中使用 `{word_count}`，但 variables 中定义的是 `word_limit`）

**解决方法**:
- 设置 `required: true` 强制用户填写
- 为每个变量设置合理的 `default` 值
- 确保占位符名称与变量定义一致

### 3. 变量解析失败

**前端控制台错误**: "解析模板变量失败"

**原因**:
- `variables` 字段的 JSON 格式错误
- 包含不支持的特殊字符

**解决方法**:
- 使用在线JSON验证工具检查格式
- 确保使用标准的 JSON 语法（双引号、无尾随逗号）

---

## 📊 数据流程图

```
用户创建任务
    ↓
选择提示词模板
    ↓
前端解析 variables 字段
    ↓
动态生成表单字段
    ↓
用户填写变量值
    ↓
提交任务 (prompt_variables保存到数据库)
    ↓
任务执行
    ↓
后端读取 prompt_variables
    ↓
替换模板中的占位符
    ↓
发送给AI生成文章
    ↓
保存生成结果
```

---

## 🚀 最佳实践

### 1. 变量命名

- 使用小写字母和下划线：`word_count`（推荐）
- 避免使用驼峰命名：`wordCount`（不推荐）
- 避免使用中文：`字数`（不推荐）

### 2. 默认值设置

- 为所有变量设置合理的默认值
- 数字类型避免使用0作为默认值
- 下拉选择必须设置默认值

### 3. 提示信息

- `label` 要简洁明了
- `placeholder` 提供示例或格式说明
- 复杂变量在模板描述中详细说明

### 4. 必填控制

- 关键参数设置 `required: true`
- 可选参数提供默认值
- 避免过多必填项影响用户体验

---

## 📚 相关文档

- [AI批量生成任务流程优化说明.md](./AI批量生成任务流程优化说明.md)
- [AI模型文本生成属性说明.md](./AI模型文本生成属性说明.md)

---

## 🔗 相关文件

**前端**:
- `frontend/src/views/ai/TaskList.vue` - 任务创建页面（动态表单生成）
- `frontend/src/api/ai.js` - API接口

**后端**:
- `backend/app/service/AiArticleGeneratorService.php` - 变量替换逻辑
- `backend/app/model/AiPromptTemplate.php` - 模板模型

**数据库**:
- `ai_prompt_templates` 表 - 存储模板和变量定义
- `ai_article_tasks` 表 - 存储任务和用户填写的变量值

---

**文档版本**: v1.0
**最后更新**: 2025-01-14
**维护者**: AI系统管理员
